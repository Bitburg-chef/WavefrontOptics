function [lpsf, mpsf, spsf, arcminperpix, psf, strehl, sceFrac] = ...    ComputeLMSPSFFromZernike(wls,T_cones,spd_weight,zcoeffs,measpupilMM,calcpupilMM,nominalFocusWl,defocusDiopters,sizeOfFieldPixels,sizeOfFieldMM,sceParams)% [lpsf, mpsf, spsf, arcminperpix, psf, strehl, sceFrac] = ...%   ComputeLMSPSFFromZernike(wls,T_cones,spd_weight,zcoeffs,measpupilMM,calcpupilMM,nominalFocusWl,defocusDiopters,sizeOfFieldPixels,sizeOfFieldMM,sceParams)%% This routine finds PSFs seen by each cone class under passed spectrum spd_weight.  It gets% these by taking a weighted sum of the monochromatic PSFs, where the weights are given by% the product of the passed LMS spectral sensitivities and the passed spectrum.  If SCE% is specified, the SCE at each wavelength is also incorporated when summing up the % monochromatic PSFs.% % The returned psfs are normalized so that they sum to unity.  If you want to figure% out the relative amount of light seen by each cone class, you need to take the% spectral sensitivities into account and also the SCE if you're using that.  The% routine does return the weighted average of the monochromatic sceFrac entries% for each cone type, to make this easier.%% Inputs - see comment in ComputePupilFunctionFromZernike for more details.%   wls -               Column vector of wavelengths over which to cone sensitivity and spectrum are specified.%   T_cones -           Cone spectral sensitivities in Psychtoolbox data format.%   spd_weight -        Weighting spectrum as a column vector.%   ... -               See ComputePSFFromZernike for description of remaining arguments.%% Outputs%   lpsf -              Calcuated L cone psf. %   mpsf -              Calcuated M cone psf.                    %   spsf -              Calcuated S cone psf.                    %   arcminperpix -      Arc minutes per pixel for returned psfs.%   lsceFrac -          Calculated L cone SCE fraction.%   msceFrac -          Calculated M cone SCE fraction.%   ssceFrac -          Calculated S cone SCE fraction.%   psf -               Calcuated monochromatic psfs. Third dimension of returned matrix indexes wavelength. %   strehl -            Strehl ratio at each wavelength for monochromatic psfs.%   sceFrac -           Fraction of light actually absorbed at each wavelength when SCE is taken into account.%% The last three returned values are those returned by ComputePSFFromZernike.%% Note 1 on usage.  If you actually know the hyperspectral image input, you probably don't want to use this routine.% Rather, compute the monochromatic PSFs at each wavelength and do your optical blurring in the wavelength domain,% before computing cone absorbtions.  Doing so is a more accurate model of the physics.%% You would use this routine under two circumstances.  First, you might know that the image consists only of % intensity modulations of a single relative spectrum.  In this case, you could use that spectrum here and speed% things up, since you'd only have to convolve three times (one for each cone class rather than once for each% wavelength).  This strikes me (DHB) as a rather special case and not too likely to be of much practical use% because computers are so fast these days that worrying about the cost of the wavelength-by-wavelength computations% seems like it will often be more trouble than it is worth.%% Second, you might only know the unblurred LMS images and not have spectral data.  Then, this routine is useful for% providing an approximation to the blurring that will occur for each cone class.  For example, your data might% originate with a high-resolution RGB camera image, which was then used to estimate LMS values at each location.% Keep in mind that what you get in that case is only an approximation, since the actual blur depends on the% full spectral image.%% Note 2 on usage.  If you want to compute a strehl ratio quantity for the LMS psfs, the most straightforward% way is to call this routine a second time using a zcoeffs vector of all zeros.  This leads to computation% of diffraction limited monochromatic psfs that are then summed just like the specified ones.  Taking the ratios% of the peaks then gives you a fairly meaningful figure of merit.%% See ComputePSFFromZernike.%% 7/13/07   dhb    Made into a callable function, based on code provided by Heidi Hofer.%           dhb    Remove globals, fix case of fft, get rid of some vars we don't care about%           dhb    Don't write files here, optional plot supression.% 7/14/07   dhb    Change name a little.% 12/22/09  dhb    Return monochromatic PSFs as a cell array% 8/21/11   dhb    Update% Handle default argsif (nargin < 11 || isempty(sceParams))    sceParams = [];end% Force wavelengths to column vector formwls = MakeItWls(wls);% Get weighted cone fundamentals, and % normalize each so it sums to one.sweight=T_cones(3,:).*spd_weight';mweight=T_cones(2,:).*spd_weight';lweight=T_cones(1,:).*spd_weight';lweight = lweight/sum(lweight);mweight = mweight/sum(mweight);sweight = sweight/sum(sweight);% Get psfs for each cone type[psf,arcminperpix,strehl,sceFrac] = ComputePSFFromZernike(zcoeffs,measpupilMM,calcpupilMM,wls,nominalFocusWl,defocusDiopters,sizeOfFieldPixels,sizeOfFieldMM,sceParams);lpsf = zeros(size(psf(:,:,1)));mpsf = zeros(size(psf(:,:,1)));spsf = zeros(size(psf(:,:,1)));for wl = 1:length(wls)    lpsf = lpsf + sceFrac(wl)*lweight(wl)*psf(:,:,wl);     mpsf = mpsf + sceFrac(wl)*mweight(wl)*psf(:,:,wl);     spsf = spsf + sceFrac(wl)*sweight(wl)*psf(:,:,wl); end% Normalize.  Because of the SCE, they might not be.lpsf = lpsf/sum(lpsf(:));mpsf = mpsf/sum(mpsf(:));spsf = spsf/sum(spsf(:));% Get sceFrac for each cone typelsceFrac = lweight .* sceFrac;msceFrac = mweight .* sceFrac;ssceFrac = sweight .* sceFrac;